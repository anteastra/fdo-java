<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<title>INTUIT.ru::Интернет-Университет Информационных Технологий</title>
<link rel="shortcut icon" href="http://www.intuit.ru/favicon.ico">


<META http-equiv="Pragma" CONTENT="no-cache">
<META http-equiv="Cache-Control" CONTENT="no-cache, must-revalidate">
<META NAME="Pragma" CONTENT="no-cache">
<META NAME="Cache-Control" CONTENT="no-cache">
<link href="../../../ssi/style.css" type="text/css" rel="stylesheet">
</head>
<body leftmargin="0" topmargin="6" marginheight="6" marginwidth="0" bgcolor="white">

<!-- header -->
<!---->
<table border="0" cellpadding="8" cellspacing="0" width="100%">
<tr valign="top">
<td><a href="http://www.intuit.ru/"><img src="../../../img/logo.gif" border="0" width="285" height="52" alt="Интернет Университет информационных технологий"></a></td>
<!---->
</tr>
</table>

<!-- /header -->

<!-- /menu -->
<table border="0" cellpadding="" cellspacing="6" width="100%">
<tr>
<td align="center" class="menu">
	<table border="0" cellpadding="0" cellspacing="0" background="" height="31">
	<tr>
	<td><a href="http://www.intuit.ru/speciality/" class="menu">Учебные программы</a></td>
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/all_departments.html" class="menu">Кафедры</a></td>	
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/all_courses.html" class="menu">Все курсы</a></td>	
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/syllabus.html" class="menu">Расписание</a></td>		
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/shop/" class="menu">Учебники</a></td>		
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/news.html" class="menu">Новости</a></td>		
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/department/forum/" class="menu">Форум</a></td>
<!--
	<td><img src="../../../img/separator.gif" width="2" height="18" border="0" hspace="7"></td>
	<td><a href="http://www.intuit.ru/help/" class="menu">Помощь</a></td>		
-->
	</tr>
	</table>	

</td>
</tr>
</table>
<!-- /menu -->


<table border="0" cellpadding="0" cellspacing="0" width="100%" height="73">
<tr valign="top">
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
<td width="180">
	<!-- leftcolumn -->
	<table border="0" cellpadding="2" cellspacing="0" background="" width="100%">

		<tr valign="middle">
	<td class="orang" height="24">&nbsp;&nbsp;Лекции</td>
	</tr>
	<tr>
	<td>
		<table border="0" cellpadding="0" cellspacing="0">

		<tr valign=top>

		<td colspan=3>
<a href="../index.html" class="spec">Программирование на Java</a>


</td>
		</tr>
<tr valign=top><td colspan="3" height="6"><img src="../../../img/empty.gif" width="1" height="6"></td></tr>

		<tr valign=top>

		<td class="llecture">1.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../1/1.html" class="llecture">Что такое Java? История создания</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">2.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../2/1.html" class="llecture">Основы объектно-ориентированного...</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">3.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../3/1.html" class="llecture">Лексика языка</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">4.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../4/1.html" class="llecture">Типы данных</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">5.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../5/1.html" class="llecture">Имена. Пакеты</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">6.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../6/1.html" class="llecture">Объявление классов</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">7.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../7/1.html" class="llecture">Преобразование типов</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">8.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../8/1.html" class="llecture">Объектная модель в Java</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">9.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../9/1.html" class="llecture">Массивы</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">10.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../10/1.html" class="llecture">Операторы и структура кода. Искл...</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">11.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../11/1.html" class="llecture">Пакет java.awt</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">12.</td>
		<td>&nbsp;</td>
<td class="llecture">


<a href="../12/1.html" class="llecture_selected">Потоки выполнения. Синхронизация</a>


</td>
		</tr>




		<tr valign=top>

		<td class="llecture">13.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../13/1.html" class="llecture">Пакет java.lang</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">14.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../14/1.html" class="llecture">Пакет java.util</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">15.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../15/1.html" class="llecture">Пакет java.io</a>
</td>
		</tr>




		<tr valign=top>

		<td class="llecture">16.</td>
		<td>&nbsp;</td>
<td class="llecture">

<a href="../16/1.html" class="llecture">Введение в сетевые протоколы</a>
</td>
		</tr>






<tr valign=top><td colspan="3" height="6"><img src="../../../img/empty.gif" width="1" height="6"></td></tr>
		<tr valign=top>

		<td class="llecture">&nbsp;</td>
<td>&nbsp;</td>

		<td class="llecture"><a href="http://www.intuit.ru/department/pl/javapl/class/examination/" class="llecture">Экзамен</a></td>
		</tr>
		<tr valign=top>

		<td class="llecture">&nbsp;</td>
<td>&nbsp;</td>

		<td class="llecture"><a class="llecture_red" href="http://www.intuit.ru/department/pl/javapl/class/examination_extern/">Сдать экзамен экстерном</a></td>
		</tr>

<tr valign=top><td colspan="3" height="6"><img src="../../../img/empty.gif" width="1" height="6"></td></tr>

		<tr valign=top>

		<td class="llecture">&nbsp;</td>
<td>&nbsp;</td>

		<td class="llecture"><a href="../lit.html" class="llecture">Литература</a></td>
		</tr>





		<tr valign=top>

		<td class="llecture">&nbsp;</td>
<td>&nbsp;</td>

		<td class="llecture"><a href="../keywords.html" class="llecture">Предметный указатель</a></td>
		</tr>



		<tr valign=top>

		<td class="llecture">&nbsp;</td>
<td>&nbsp;</td>

		<td class="llecture"><a href="../examples.html" class="llecture">Примеры</a></td>
		</tr>


		</table><br>
	</td>
	</tr>


	

	<tr valign="middle">
	<td class="orang" height="24">&nbsp;&nbsp;Общение</td>
	</tr>
	<tr>
	<td>
		<table border="0" cellpadding="0" cellspacing="0">

		<tr valign=top>
		<td><img src="../../../img/arrow.gif" border="0" width="6" height="7" hspace="5" vspace="5"></td>
		<td><a href="http://www.intuit.ru/department/pl/javapl/class/classmates/" class="spec">однокурсники</a></td>
		</tr>
		

		<tr valign=top>
		<td><img src="../../../img/arrow.gif" border="0" width="6" height="7" hspace="5" vspace="5"></td>
		<td><a href="http://www.intuit.ru/department/pl/javapl/forum/" class="spec">форум по курсу</a></td>
		</tr>

		<tr valign=top>
		<td><img src="../../../img/arrow.gif" border="0" width="6" height="7" hspace="5" vspace="5"></td>
		<td><a href="http://www.intuit.ru/department/pl/javapl/class/question_for_lector/" class="spec">вопрос преподавателю</a></td>
		</tr>

		<tr valign=top>
		<td><img src="../../../img/arrow.gif" border="0" width="6" height="7" hspace="5" vspace="5"></td>
		<td><a href="http://www.intuit.ru/department/pl/javapl/class/opinions/" class="spec">мнения о курсе</a></td>
		</tr>

		<tr valign=top>
		<td><img src="../../../img/arrow.gif" border="0" width="6" height="7" hspace="5" vspace="5"></td>
		<td><a href="http://www.intuit.ru/department/pl/javapl/class/rating/" class="spec">рейтинг выпускников</a></td>
		</tr>


		</table><br>
	</td>
	</tr>



<tr><td height="1"><a href="../robot.html"><img src="../../../img/empty.gif" width="1" height="1" border="0"></a></td></tr>

	</table>

	<!-- #include virtual="~/inc/leftcolumn.html" -->
	<!-- /leftcolumn -->	
</td>
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
<td width="1" class="gray"><img src="../../../img/empty.gif"></td>
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
<td>
	<!-- content -->
	<table border="0" cellpadding="0" cellspacing="0" width="100%">
	<tr><td class="head" colspan=2>Программирование на Java</td></tr>
<tr><td colspan=2 height="4"><img src="../../../img/empty.gif" width="1" height="4"></td></tr>
	<tr><td class="orang" height="1" colspan=2><img src="../../../img/empty.gif" width="1" height="1"></td></tr>
	<tr><td height="8" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>




<tr>
<td colspan="2" align=left class="headsub">Лекция #12: <a href="../12/1.html">Потоки выполнения. Синхронизация</a></td>
</tr>

<tr><td height="6" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>
<tr><td class="orang" height="1" colspan=2><img src="../../../img/empty.gif" width="1" height="1"></td></tr>
<tr><td height="2" colspan=2><img src="../../../img/empty.gif" width="1" height="2"></td></tr>


<tr>

<td align=left><font class="rtitle">Страницы:</font>
<a class="rtitle" href="2.html">&laquo;</a> <font class="stitle">|</font>


<a class="rtitle" href="1.html">1</a>
<font class="stitle">|</font>


<a class="rtitle" href="2.html">2</a>
<font class="stitle">|</font>

<font class="rtitle">3</font>

<font class="stitle">|</font>


<a class="rtitle" href="4.html">4</a>
<font class="stitle">|</font>


<a class="rtitle" href="http://www.intuit.ru/department/pl/javapl/12/test/">вопросы</a> <font class="stitle">|</font> 
<a class="rtitle" href="4.html"><b>&raquo;</b></a>
</td>
<td align=right><font class="stitle">|</font>
<a href="http://www.intuit.ru/department/pl/javapl/12/javapl_12.html" class="rtitle" target="_blank">HTML для печати</a>




</td>

</tr>


	<tr><td height="2" colspan=2><img src="../../../img/empty.gif" width="1" height="2"></td></tr>
<tr><td align="center" class="orang_light" colspan="2">
&nbsp;
<font class="rtxt">Если Вы заметили ошибку на этой странице - <a class="llecture_red" target="_blank" href="http://www.intuit.ru/help/askform.xhtml?course=57&url=http://www.intuit.ru/department/pl/javapl/12/3.html">сообщите нам.</a></font>
&nbsp;
</td></tr>

	<tr><td height="8" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>
	<tr><td colspan=2>


    
    <h3 >Синхронизация</h3>
        
        <p >При многопоточной архитектуре приложения возможны ситуации, когда несколько потоков будут одновременно работать с одними и теми же данными, используя их значения и присваивая новые. В таком случае результат работы программы становится невозможно предугадать, глядя только на исходный код. Финальные значения переменных будут зависеть от случайных факторов, исходя из того, какой поток какое действие успел сделать первым или последним.</p>
        <p >Рассмотрим пример:</p>
        <a  name="example.12.3"></a><div  class="example"><span class="objectName">
            Пример 
            12.3.
            
            (<a href="example.12.3.htm" target="_blank" onClick="window.open('example.12.3.htm','','menubar=no,scrollbars=yes,resizable=yes');return false;" class="objectName">html</a>,
            <a href="example.12.3.txt" target="_blank" onClick="window.open('example.12.3.txt','','menubar=no,scrollbars=yes,resizable=yes');return false;" class="objectName">txt</a>)
            </span></div>
        <p >В этом примере два потока исполнения одновременно обращаются к одному и тому же объекту, вызывая у него два разных метода, <span class="texample">one()</span> и <span class="texample">two()</span>. Эти методы пытаются приравнять два поля класса <span class="texample">a</span> и <span class="texample">b</span> друг другу, но в разном порядке. Учитывая, что исходные значения полей равны <span class="texample">1</span> и <span class="texample">2</span>, соответственно, можно было ожидать, что после того, как потоки завершат свою работу, поля будут иметь одинаковое значение. Однако понять, какое из двух возможных значений они примут, уже невозможно. Посмотрим на результат программы:</p>
        <div  class="example"><pre>
135 864 1 
   </pre></div>
        <p >Первое число показывает, сколько раз из тысячи обе переменные приняли значение <span class="texample">1</span>. Второе число соответствует значению <span class="texample">2</span>. Такое сильное преобладание одного из значений обусловлено последовательностью запусков потоков. Если ее изменить, то и количества случаев с <span class="texample">1</span> и <span class="texample">2</span> также меняются местами. Третье же число сообщает, что на тысячу случаев произошел один, когда поля вообще обменялись значениями!</p>
        <p >При количестве итераций, равном 10000, были получены следующие данные, которые подтверждают сделанные выводы:</p>
        <div  class="example"><pre>
494 9498 8 
   </pre></div>
        <p >А если убрать задержку перед анализом результатов, то получаемые данные радикально меняются:</p>
        <div  class="example"><pre>
0 3 997 
   </pre></div>
        <p >Видимо, потоки просто не успевают отработать.</p>
        <p >Итак, наглядно показано, сколь сильно и непредсказуемо может меняться результат работы одной и той же программы, применяющей многопоточную архитектуру. Необходимо учитывать, что в приведенном простом примере задержки создавались вручную методом <span class="texample">Thread.sleep()</span>. В реальных сложных системах задержки могут возникать в местах проведения сложных операций, их длина непредсказуема и оценить их последствия невозможно.</p>
        <p >Для более глубокого понимания принципов многопоточной работы в Java рассмотрим организацию памяти в виртуальной машине для нескольких потоков.</p>
        <h4 >Хранение переменных в памяти</h4>
            
            <p >Виртуальная машина поддерживает основное хранилище данных (main storage), в котором сохраняются значения всех переменных и которое используется всеми потоками. Под переменными здесь понимаются поля объектов и классов, а также элементы массивов. Что касается локальных переменных и параметров методов, то их значения не могут быть доступны другим потокам, поэтому они не представляют интереса.</p>
            <p >Для каждого потока создается его собственная рабочая память (working memory), в которую перед использованием копируются значения всех переменных.</p>
            <p >Рассмотрим основные операции, доступные для потоков при работе с памятью:</p>
            <ul >
                <li>
                    <span class="texample">use</span> – чтение значения переменной из рабочей памяти потока;</li>
                <li>
                    <span class="texample">assign</span> – запись значения переменной в рабочую память потока;</li>
                <li>
                    <span class="texample">read</span> – получение значения переменной из основного хранилища;</li>
                <li>
                    <span class="texample">load</span> – сохранение значения переменной, прочитанного из основного хранилища, в рабочей памяти;</li>
                <li>
                    <span class="texample">store</span> – передача значения переменной из рабочей памяти в основное хранилище для дальнейшего хранения;</li>
                <li>
                    <span class="texample">write</span> – сохраняет в основном хранилище значение переменной, переданной командой store.</li>
            </ul>
            <p >Подчеркнем, что перечисленные команды не являются методами каких-либо классов, они недоступны программисту. Сама виртуальная машина использует их для обеспечения корректной работы потоков исполнения.</p>
            <p >Поток, работая с переменной, регулярно применяет команды <span class="texample">use</span> и <span class="texample">assign</span> для использования ее текущего значения и присвоения нового. Кроме того, должны осуществляться действия по передаче значений в основное хранилище и из него. Они выполняются в два этапа. При получении данных сначала основное хранилище считывает значение командой <span class="texample">read</span>, а затем поток сохраняет результат в своей рабочей памяти командой <span class="texample">load</span>. Эта пара команд всегда выполняется вместе именно в таком порядке, т.е. нельзя выполнить одну, не выполнив другую. При отправлении данных сначала поток считывает значение из рабочей памяти командой <span class="texample">store</span>, а затем основное хранилище сохраняет его командой <span class="texample">write</span>. Эта пара команд также всегда выполняется вместе именно в таком порядке, т.е. нельзя выполнить одну, не выполнив другую.</p>
            <p >Набор этих правил составлялся с тем, чтобы операции с памятью были достаточно строги для точного анализа их результатов, а с другой стороны, правила должны оставлять достаточное пространство для различных технологий оптимизаций (регистры, очереди, кэш и т.д.).</p>
            <p >Последовательность команд подчиняется следующим правилам:</p>
            <ul >
                <li>все действия, выполняемые одним потоком, строго упорядочены, т.е. выполняются одно за другим;</li>
                <li>все действия, выполняемые с одной переменной в основном хранилище памяти, строго упорядочены, т.е. следуют одно за другим.</li>
            </ul>
            <p >За исключением некоторых дополнительных очевидных правил, больше никаких ограничений нет. Например, если поток изменил значение сначала одной, а затем другой переменной, то эти изменения могут быть переданы в основное хранилище в обратном порядке.</p>
            <p >Поток создается с чистой рабочей памятью и должен перед использованием загрузить все необходимые переменные из основного хранилища. Любая переменная сначала создается в основном хранилище и лишь затем копируется в рабочую память потоков, которые будут ее применять.</p>
            <p >Таким образом, потоки никогда не взаимодействуют друг с другом напрямую, только через главное хранилище.</p>
        
        <h4 >Модификатор volatile</h4>
            
            <p >При объявлении полей объектов и классов может быть указан модификатор <span class="texample">volatile</span>. Он устанавливает более строгие правила работы со значениями переменных.</p>
            <p >Если поток собирается выполнить команду <span class="texample">use</span> для <span class="texample">volatile</span> переменной, то требуется, чтобы предыдущим действием с этой переменной было обязательно <span class="texample">load</span>, и наоборот – операция <span class="texample">load</span> может выполняться только перед <span class="texample">use</span>. Таким образом, переменная и главное хранилище всегда имеют самое последнее значение этой переменной.</p>
            <p >Аналогично, если поток собирается выполнить команду <span class="texample">store</span> для <span class="texample">volatile</span> переменной, то требуется, чтобы предыдущим действием над этой переменной было обязательно <span class="texample">assign</span>, и наоборот – операция <span class="texample">assign</span> может выполняться, только если следующей будет <span class="texample">store</span>. Таким образом, переменная и главное хранилище всегда имеют самое последнее значение этой переменной.</p>
            <p >Наконец, если проводятся операции над несколькими <span class="texample">volatile</span> переменными, то передача соответствующих изменений в основное хранилище должна проводиться строго в том же порядке.</p>
            <p >При работе с обычными переменными компилятор имеет больше пространства для маневра. Например, при благоприятных обстоятельствах может оказаться возможным предсказать значение переменной, заранее вычислить и сохранить его, а затем в нужный момент использовать уже готовым.</p>
            <p >Следует обратить внимание на два 64-разрядных типа, <span class="texample">double</span> и <span class="texample">long</span>. Поскольку многие платформы поддерживают лишь 32-битную память, величины этих типов рассматриваются как две переменные и все описанные действия выполняются независимо для двух половинок таких значений. Конечно, если производитель виртуальной машины считает возможным, он может обеспечить атомарность операций и над этими типами. Для <span class="texample">volatile</span> переменных это является обязательным требованием.</p>
        
        <h4 >Блокировки</h4>
            
            <p >В основном хранилище для каждого объекта поддерживается блокировка (<span class="texample">lock</span>), над которой можно произвести два действия – установить (<span class="texample">lock</span>) и снять (<span class="texample">unlock</span>). Только один поток в один момент времени может установить блокировку на некоторый объект. Если до того, как этот поток выполнит операцию <span class="texample">unlock</span>, другой поток попытается установить блокировку, его выполнение будет приостановлено до тех пор, пока первый поток не отпустит ее.</p>
            <p >Операции <span class="texample">lock</span> и <span class="texample">unlock</span> накладывают жесткое ограничение на работу с переменными в рабочей памяти потока. После успешно выполненного <span class="texample">lock</span> рабочая память очищается и все переменные необходимо заново считывать из основного хранилища. Аналогично, перед операцией <span class="texample">unlock</span> необходимо все переменные сохранить в основном хранилище.</p>
            <p >Важно подчеркнуть, что блокировка является чем-то вроде флага. Если блокировка на объект установлена, это не означает, что данным объектом нельзя пользоваться, что его поля и методы становятся недоступными,– это не так. Единственное действие, которое становится невозможным,– установка этой же блокировки другим потоком, до тех пор, пока первый поток не выполнит <span class="texample">unlock</span>.</p>
            <p >В Java-программе для того, чтобы воспользоваться механизмом блокировок, существует ключевое слово <span class="texample">synchronized</span>. Оно может быть применено в двух вариантах – для объявления <span class="texample">synchronized</span>-блока и как модификатор метода. В обоих случаях действие его примерно одинаковое.</p>
            <p >
                <span class="texample">Synchronized</span>-блок записывается следующим образом:</p>
            <div  class="example"><pre>
synchronized (ref) {
   ...
} 
      </pre></div>
            <p >Прежде, чем начать выполнять действия, описанные в этом блоке, поток обязан установить блокировку на объект, на который ссылается переменная <span class="texample">ref</span> (поэтому она не может быть <span class="texample">null</span>). Если другой поток уже установил блокировку на этот объект, то выполнение первого потока приостанавливается до тех пор, пока не удастся выполнить операцию <span class="texample">lock</span>.</p>
            <p >После этого блок выполняется. При завершении исполнения (как успешном, так и в случае ошибок) производится операция <span class="texample">unlock</span>, чтобы освободить объект для других потоков.</p>
            <p >Рассмотрим пример:</p>
            <div  class="example"><pre>
public class ThreadTest implements Runnable {
   private static ThreadTest 
                  shared = new ThreadTest();
   public void process() {
      for (int i=0; i&lt;3; i++) {
         System.out.println(
                    Thread.currentThread().
            getName()+" "+i);
         Thread&gt;.yield();
      }
   }

   public void run() {
      shared.process();
   }
   public static void main(String s[]) {
      for (int i=0; i&lt;3; i++) {
         new Thread(new ThreadTest(),
            "Thread-"+i).start();
      }
   }
} 
      </pre></div>
            <p >В этом простом примере три потока вызывают метод у одного объекта, чтобы тот распечатал три значения. Результатом будет:</p>
            <div  class="example"><pre>
Thread-0 0
Thread-1 0
Thread-2 0
Thread-0 1
Thread&gt;-2 1
Thread-0 2
Thread-1 1
Thread-2 2
Thread-1 2
      </pre></div>
            <p >То есть все потоки одновременно работают с одним методом одного объекта. Заключим обращение к методу в <span class="texample">synchronized</span>-блок:</p>
            <div  class="example"><pre>
public void run() {
   synchronized (shared) {
      shared.process();
   }
} 
      </pre></div>
            <p >Теперь результат будет строго упорядочен:</p>
            <div  class="example"><pre>
Thread-0 0
Thread-0 1
Thread-0 2
Thread-1 0
Thread-1 1
Thread-1 2
Thread-2 0
Thread-2 1
Thread-2 2
      </pre></div>
            <p >
                <span class="texample">Synchronized</span>-методы работают аналогичным образом. Прежде, чем начать выполнять их, поток пытается заблокировать объект, у которого вызывается метод. После выполнения блокировка снимается. В предыдущем примере аналогичной упорядоченности можно было добиться, если использовать не <span class="texample">synchronized</span>-блок, а объявить метод <span class="texample">process()</span> синхронизированным.</p>
            <p >Также допустимы методы <span class="texample">static synchronized</span>. При их вызове блокировка устанавливается на объект класса <span class="texample">Class</span>, отвечающего за тип, у которого вызывается этот метод.</p>
            <p >При работе с блокировками всегда надо помнить о возможности появления <span class="texample">deadlock</span> – взаимных блокировок, которые приводят к зависанию программы. Если один поток заблокировал один ресурс и пытается заблокировать второй, а другой поток заблокировал второй и пытается заблокировать первый, то такие потоки уже никогда не выйдут из состояния ожидания.</p>
            <p >Рассмотрим простейший пример:</p>
            <a  name="example.12.4"></a><div  class="example"><span class="objectName">
            Пример 
            12.4.
            
            (<a href="example.12.4.htm" target="_blank" onClick="window.open('example.12.4.htm','','menubar=no,scrollbars=yes,resizable=yes');return false;" class="objectName">html</a>,
            <a href="example.12.4.txt" target="_blank" onClick="window.open('example.12.4.txt','','menubar=no,scrollbars=yes,resizable=yes');return false;" class="objectName">txt</a>)
            </span></div>
            <p >Если запустить такую программу, то она никогда не закончит свою работу. Обратите внимание на вызовы метода <span class="texample">yield()</span> в каждом потоке. Они гарантируют, что когда один поток выполнил первую блокировку и переходит к следующей, второй поток находится в таком же состоянии. Очевидно, что в результате оба потока "замрут", не смогут продолжить свое выполнение. Первый поток будет ждать освобождения второго объекта, и наоборот. Именно такая ситуация называется "мертвой блокировкой", или <span class="texample">deadlock</span>. Если один из потоков успел бы заблокировать оба объекта, то программа успешно бы выполнилась до конца. Однако многопоточная архитектура не дает никаких гарантий, как именно потоки будут выполняться друг относительно друга. Задержки (которые в примере моделируются вызовами <span class="texample">yield()</span>) могут возникать из логики программы (необходимость произвести вычисления), действий пользователя (не сразу нажал кнопку "ОК"), занятости ОС (из-за нехватки физической оперативной памяти пришлось воспольз
оваться виртуальной), значений <span class="keyword">приоритетов потоков</span> и так далее.</p>
            <p >В Java нет никаких средств распознавания или предотвращения ситуаций <span class="texample">deadlock</span>. Также нет способа перед вызовом синхронизированного метода узнать, заблокирован ли уже объект другим потоком. Программист сам должен строить работу программы таким образом, чтобы неразрешимые блокировки не возникали. Например, в рассмотренном примере достаточно было организовать блокировки объектов в одном порядке (всегда сначала первый, затем второй) – и программа всегда выполнялась бы успешно.</p>
            <p >Опасность возникновения взаимных блокировок заставляет с особенным вниманием относиться к работе с потоками. Например, важно помнить, что если у объекта потока был вызван метод <span class="texample">sleep(..)</span>, то такой поток будет бездействовать определенное время, но при этом все заблокированные им объекты будут оставаться недоступными для блокировок со стороны других потоков, а это потенциальный <span class="texample">deadlock</span>. Такие ситуации крайне сложно выявить путем тестирования и отладки, поэтому вопросам синхронизации надо уделять много времени на этапе проектирования.</p>
        


    
	</td>		
	</tr>
	<tr><td height="8" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>

	<tr><td height="8" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>
	<tr><td colspan=2 align="center">

<a href="4.html" class="attention">Перейти к следующей странице &raquo;</b></a>

	</td></tr>
	<tr><td height="16" colspan=2><img src="../../../img/empty.gif" width="1" height="16"></td></tr>

<tr><td align="center" class="orang_light" colspan="2">
&nbsp;
<font class="rtxt">Если Вы заметили ошибку на этой странице - <a class="llecture_red" target="_blank" href="http://www.intuit.ru/help/askform.xhtml?course=57&url=http://www.intuit.ru/department/pl/javapl/12/3.html">сообщите нам.</a></font>
&nbsp;
</td></tr>

	<tr><td height="2" colspan=2><img src="../../../img/empty.gif" width="1" height="2"></td></tr>
<tr>

<td align=left><font class="rtitle">Страницы:</font>
<a class="rtitle" href="2.html">&laquo;</a> <font class="stitle">|</font>


<a class="rtitle" href="1.html">1</a>
<font class="stitle">|</font>


<a class="rtitle" href="2.html">2</a>
<font class="stitle">|</font>

<font class="rtitle">3</font>

<font class="stitle">|</font>


<a class="rtitle" href="4.html">4</a>
<font class="stitle">|</font>


<a class="rtitle" href="http://www.intuit.ru/department/pl/javapl/12/test/">вопросы</a> <font class="stitle">|</font> 
<a class="rtitle" href="4.html"><b>&raquo;</b></a>
</td>
<td align=right><font class="stitle">|</font>
<a href="http://www.intuit.ru/department/pl/javapl/12/javapl_12.html" class="rtitle" target="_blank">HTML для печати</a>




</td>

</tr>

	<tr><td height="8" colspan=2><img src="../../../img/empty.gif" width="1" height="8"></td></tr>
	<tr><td class="orang" height="1" colspan=2><img src="../../../img/empty.gif" width="1" height="1"></td></tr>
	</table>
	<!-- /content -->

</td>
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
<td width="1" class="gray"><img src="../../../img/empty.gif"></td>
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
<td width="180">
	<!-- rightcolumn -->
	<table border="0" cellpadding="2" cellspacing="0" background="" width="100%">
	<!---->


<!--Основные понятия-->
	<td class="bordo" height="24">&nbsp;&nbsp;Ключевые слова</td>
	</tr>
	<tr>
	<td><span class="rtxt"><span  class="keyword_list">приоритет потока</span><br ><br ><a  class="allnews" href="../keywords.html">все ключевые слова »</a>
</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
<!--/Основные понятия-->

		<tr><td class="bordo" height="24">&nbsp;&nbsp;Информация о лекции</td></tr>
	<tr>
	<td>
<span class="rtxt">В этой лекции завершается описание ключевых особенностей Java. Последняя тема раскрывает особенности создания многопоточных приложений – такая возможность присутствует в языке, начиная с самых первых версий. <br>
Первый вопрос – как на много – и, самое интересное, однопроцессорных машинах выполняется несколько потоков одновременно и для чего они нужны в программе. Затем описываются классы, необходимые для создания, запуска и управления потоками в Java. При одновременной работе с данными из нескольких мест возникает проблема синхронного доступа, блокировок и, как следствие, взаимных блокировок. Изучаются все механизмы, предусмотренные в языке для корректной организации такой логики работы.

	</td>
	</tr>
	<tr><td>&nbsp;</td></tr>

	

	
	<td class="bordo" height="24">&nbsp;&nbsp;Учебники к курсу</td>
	</tr>
	<tr>
<td>

		<table border="0" cellpadding="0" cellspacing="0">


		<tr valign="top">
		<td>

<table border="0" cellpadding="1" cellspacing="0"  align="left" hspace="5" vspace="2"><tr><td class="orang"><table border="0" cellpadding="2" cellspacing="0" bgcolor="#ffffff"><tr><td valign="middle" align="center"><a href="http://www.intuit.ru/shop/catalog/product.xhtml?id=2459325"><img width="72" height="105" src="../../../img/covers/i/in/int/intu006.jpg" alt="Программирование на Java" border="0"></a></td></tr></table></td></tr></table>

<a href="http://www.intuit.ru/shop/catalog/product.xhtml?id=2459325" class="spectitle">
Программирование на Java</a>
<br>
<font class="spectxt">
Вязовик Н.А.,
<br>
Интернет-университет информационных технологий - ИНТУИТ.ру.
<br>
Курс лекций посвящен современному и мощному языку программирования Java. В его рамках дается вводное изложение принципов ООП, необходимое для разработки на Java, основы языка, библиотеки для работы с файлами, сетью, для построения оконного интерфейса пользователя (GUI) и др.

</font>
		</td>
		</tr>

		</table>

</td>
	</tr>


	<tr><td height="10"><img src="../../../img/empty.gif" width="1" height="10"></td></tr>



	<tr>
<td>
		<table border="0" cellpadding="0" cellspacing="0">


		<tr valign="top">
		<td class="spectxt">
<span class="spectitle"><a href="http://www.intuit.ru/shop/catalog/product.xhtml?id=1412049" class="spectitle">Приемы объектно-ориентированного проектирования. Паттерны проектирования</a></span>
<br>
Гамма Э. и др.,
Питер.
		</td>
		</tr>


		</table>

</td>
	</tr>


<tr>
<td><a href="http://www.intuit.ru/cgi-bin/goto.fcgi?mode=books_of_course&cid=57" class="allnews">все книги по курсу &raquo;</a></td>
</tr>



	</table>
	<!-- /rightcolumn -->
</td>
<td width="6"><img src="../../../img/empty.gif" width="6"></td>
</tr>
</table>

<!-- /bottom -->
<table border="0" cellpadding="0" cellspacing="6" width="100%" height="73">
<tr>
<td align="center" class="menu">
    <table border="0" cellpadding="0" cellspacing="0" background="">
    <tr>
    <td class="copy">
    <a href="http://www.intuit.ru/all_departments.html" class="bot">Кафедры</a> |
    <a href="http://www.intuit.ru/all_courses.html" class="bot">Все курсы</a> |
    <a href="http://www.intuit.ru/syllabus.html" class="bot">Расписание</a> |
    <a href="http://www.intuit.ru/shop/catalog/index.html?" class="bot">Учебники</a> | 
    <a href="http://www.intuit.ru/news.html" class="bot">Новости</a> | 
    <a href="http://www.intuit.ru/department/forum/" class="bot">Форум</a>
    <br>
    <a href="http://www.intuit.ru/user/classes/" class="bot">Мои курсы</a> | 
    <a href="http://www.intuit.ru/user/adjustments/" class="bot">Личные настройки</a> | 
    <a href="http://www.intuit.ru/user/cart/" class="bot">Корзина</a> | 
    <a href="http://www.intuit.ru/help/" class="bot">Помощь</a><br><br>
    Телефон: (095) 253-9312, 253-9313, факс: (095) 253-9310, email: <a href="http://www.intuit.ru/help/askform.xhtml" class="bot">info@intuit.ru</a><br>
    Адрес: 123056 Москва, Электрический пер., 8, стр. 3<br>
    &copy; 2003-2004 INTUIT.ru. Все права защищены.
    </td>
    </tr>
    </table>
</td>
</tr>
</table>
<!-- /bottom -->


</body>
</html>
